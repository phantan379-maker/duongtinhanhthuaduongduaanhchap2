<!doctype html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ƒê∆∞·ªùng ƒêua Ch√¢n L√Ω - The Truth Highway</title>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">
  
  <style>
    /* --- CSS C≈® GI·ªÆ NGUY√äN --- */
    body { margin: 0; padding: 0; font-family: 'Orbitron', 'Rajdhani', monospace; overflow: hidden; background: #000; }
    html, body, .game-wrapper { height: 100%; width: 100%; }
    .game-wrapper { background: linear-gradient(180deg, #0a0e27 0%, #1a1a2e 50%, #0f3460 100%); display: flex; flex-direction: column; position: relative; overflow: hidden; }
    .start-screen { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; padding: 2rem; text-align: center; position: relative; z-index: 10; }
    .neon-title { font-size: 4rem; font-weight: 900; color: #00ff41; text-shadow: 0 0 10px #00ff41, 0 0 20px #00ff41; margin-bottom: 1rem; animation: flicker 3s infinite alternate; }
    @keyframes flicker { 0%, 19%, 21%, 23%, 25%, 54%, 56%, 100% { text-shadow: 0 0 10px #00ff41, 0 0 20px #00ff41; } 20%, 24%, 55% { text-shadow: none; } }
    .story-intro { font-size: 1.1rem; color: #ffffff; max-width: 700px; line-height: 1.8; margin-bottom: 2rem; background: rgba(0, 0, 0, 0.5); padding: 1.5rem; border-radius: 15px; border: 2px solid #00ff41; font-family: 'Rajdhani', sans-serif; }
    .start-input { width: 100%; max-width: 450px; padding: 1.2rem 2rem; font-size: 1.2rem; border: 3px solid #00ff41; border-radius: 10px; background: rgba(0, 0, 0, 0.8); color: #00ff41; margin-bottom: 2rem; text-align: center; font-weight: 700; }
    .start-button { padding: 1.2rem 4rem; font-size: 1.4rem; font-weight: 900; background: linear-gradient(135deg, #ff0000 0%, #ff6b00 100%); color: white; border: 3px solid #ffff00; border-radius: 10px; cursor: pointer; transition: all 0.3s; box-shadow: 0 0 20px rgba(255, 0, 0, 0.6); }
    .start-button:hover { transform: translateY(-3px) scale(1.05); box-shadow: 0 0 40px rgba(255, 0, 0, 0.8); }
    .racing-screen { display: none; height: 100%; position: relative; overflow: hidden; }
    .highway-container { height: 100%; width: 100%; position: relative; background: #2c2c2c; perspective: 1000px; overflow: hidden; }
    .road { position: absolute; bottom: 0; left: 0; right: 0; height: 100%; background: repeating-linear-gradient(0deg, #1a1a1a 0px, #1a1a1a 50px, #2c2c2c 50px, #2c2c2c 100px); animation: roadScroll 0.5s linear infinite; transform: rotateX(20deg); transform-origin: bottom; }
    .road.slow-motion { animation: roadScroll 4s linear infinite; }
    @keyframes roadScroll { from { background-position: 0 0; } to { background-position: 0 100px; } }
    .lane-lines { position: absolute; top: 0; bottom: 0; left: 0; right: 0; display: flex; justify-content: space-around; padding: 0 10%; }
    .lane-line { width: 4px; height: 100%; background: repeating-linear-gradient(0deg, #ffff00 0px, #ffff00 40px, transparent 40px, transparent 80px); animation: laneScroll 0.5s linear infinite; }
    .lane-line.slow-motion { animation: laneScroll 4s linear infinite; }
    @keyframes laneScroll { from { background-position: 0 0; } to { background-position: 0 80px; } }
    
    .obstacle { position: absolute; bottom: 40%; transform: translateX(-50%); z-index: 95; display: none; }
    .rock-graphic { width: 80px; height: 60px; background: #7f8c8d; border-radius: 40% 60% 60% 40% / 60% 30% 70% 40%; border: 3px solid #2c3e50; box-shadow: inset -10px -10px 0 rgba(0,0,0,0.3), 0 10px 20px rgba(0,0,0,0.8); position: relative; }
    .rock-graphic::after { content: ''; position: absolute; top: 15px; left: 20px; width: 15px; height: 8px; background: rgba(0,0,0,0.2); border-radius: 50%; }
    .obstacle.lane-a { left: 15%; } .obstacle.lane-b { left: 38%; } .obstacle.lane-c { left: 62%; } .obstacle.lane-d { left: 85%; }

    .explosion-container { position: absolute; bottom: 40%; transform: translate(-50%, 50%); z-index: 150; display: none; pointer-events: none; }
    .explosion-container.active { display: block; }
    .explosion-core { width: 20px; height: 20px; border-radius: 50%; background: radial-gradient(circle, #ffeb3b 0%, #ff9800 40%, #f44336 70%, transparent 100%); animation: explosionAnim 0.8s ease-out forwards; box-shadow: 0 0 20px #ff9800; }
    .explosion-text { position: absolute; top: -60px; left: 50%; transform: translateX(-50%) scale(0); color: #ffff00; font-weight: 900; font-size: 3rem; font-style: italic; text-shadow: 4px 4px 0 #ff0000; animation: textPop 0.6s ease-out forwards; white-space: nowrap; }
    @keyframes explosionAnim { 0% { transform: scale(1); opacity: 1; } 30% { transform: scale(8); opacity: 1; } 100% { transform: scale(12); opacity: 0; } }
    @keyframes textPop { 0% { transform: translateX(-50%) scale(0) rotate(-10deg); opacity: 0; } 50% { transform: translateX(-50%) scale(1.5) rotate(10deg); opacity: 1; } 100% { transform: translateX(-50%) scale(1) rotate(0deg); opacity: 0; top: -100px; } }
    .explosion-container.lane-a { left: 15%; } .explosion-container.lane-b { left: 38%; } .explosion-container.lane-c { left: 62%; } .explosion-container.lane-d { left: 85%; }

    .bike { position: absolute; bottom: 15%; left: 50%; transform: translateX(-50%); font-size: 5rem; z-index: 100; transition: left 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55); filter: drop-shadow(0 10px 20px rgba(0, 0, 0, 0.5)); }
    .bike.crashed { animation: shake 0.5s ease-in-out; filter: sepia(1) hue-rotate(-50deg) saturate(5) brightness(0.6); }
    @keyframes shake { 0% { transform: translateX(-50%) rotate(0deg); } 10%, 90% { transform: translateX(-55%) rotate(-5deg); } 20%, 80% { transform: translateX(-45%) rotate(5deg); } 100% { transform: translateX(-50%) rotate(0deg); } }
    .bike.lane-a { left: 15%; } .bike.lane-b { left: 38%; } .bike.lane-c { left: 62%; } .bike.lane-d { left: 85%; }

    .hud { position: absolute; top: 0; left: 0; right: 0; padding: 2rem; display: flex; justify-content: space-between; z-index: 200; pointer-events: none; }
    .hud-item { background: rgba(0, 0, 0, 0.8); padding: 1rem 2rem; border: 2px solid #00ff41; font-size: 1.3rem; color: #00ff41; font-weight: 700; text-shadow: 0 0 10px #00ff41; }
    
    .question-panel { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0, 0, 0, 0.95); padding: 2rem; border: 4px solid #00ff41; width: 800px; max-width: 90%; z-index: 300; display: none; box-shadow: 0 0 40px rgba(0, 255, 65, 0.6); text-align: center; }
    .bullet-time-text { color: #00d9ff; font-size: 1.2rem; text-transform: uppercase; letter-spacing: 3px; margin-bottom: 1rem; animation: pulse 1s infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    .question-text { font-size: 1.5rem; color: #fff; margin-bottom: 2rem; line-height: 1.6; }
    .countdown { font-size: 3rem; color: #ff0000; font-weight: 900; }

    .lane-choices { position: absolute; bottom: 0; left: 0; right: 0; height: 30%; display: flex; z-index: 250; pointer-events: all; }
    .lane-choice { flex: 1; background: linear-gradient(180deg, rgba(0, 255, 65, 0.1) 0%, rgba(0, 255, 65, 0.3) 100%); border: 1px dashed rgba(0, 255, 65, 0.3); cursor: pointer; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 1rem; transition: 0.3s; }
    .lane-choice:hover { background: rgba(0, 255, 65, 0.4); border: 2px solid #00ff41; }
    .lane-label { font-size: 2.5rem; font-weight: 900; color: #00ff41; text-shadow: 0 0 15px #00ff41; }
    .lane-answer { color: #fff; text-align: center; margin-top: 10px; font-family: 'Rajdhani'; font-weight: bold;}
    .lane-choice.correct { background: rgba(0, 255, 0, 0.6); border-color: #00ff00; }
    .lane-choice.incorrect { background: rgba(255, 0, 0, 0.6); border-color: #ff0000; }

    .flashback-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.98); z-index: 400; display: none; flex-direction: column; justify-content: center; align-items: center; }
    .flashback-title { font-size: 3rem; color: #ff0000; text-transform: uppercase; animation: glitch 0.2s infinite; }
    @keyframes glitch { 0% { transform: translate(0); } 20% { transform: translate(-2px, 2px); } 40% { transform: translate(2px, -2px); } 100% { transform: translate(0); } }
    .flashback-scene { font-size: 6rem; margin: 20px 0; }
    .flashback-text { color: #fff; max-width: 600px; text-align: center; font-size: 1.5rem; line-height: 1.6; border: 2px solid red; padding: 20px; }

    .explanation-panel { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #000; border: 4px solid #00d9ff; padding: 2rem; width: 800px; max-width: 90%; z-index: 350; display: none; text-align: center; }
    .explanation-title { font-size: 2rem; margin-bottom: 1rem; font-weight: bold; }
    .explanation-title.correct { color: #00ff00; }
    .explanation-title.incorrect { color: #ff0000; }
    .explanation-text { color: #fff; font-size: 1.2rem; margin-bottom: 2rem; font-family: 'Rajdhani'; }
    .next-button { padding: 1rem 3rem; font-size: 1.2rem; background: #00ff41; border: none; cursor: pointer; font-weight: bold; text-transform: uppercase; }

    .results-screen { display: none; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: #fff; }
    .results-score { font-size: 3rem; color: #ffff00; margin: 20px 0; text-shadow: 0 0 20px #ffff00; }
    .results-message { font-size: 1.5rem; max-width: 600px; text-align: center; margin-bottom: 30px; }

    /* --- C√ÅC PH·∫¶N M·ªöI CHO V√íNG QUAY MAY M·∫ÆN (LUCKY WHEEL) --- */
    
    /* Overlay v√≤ng quay */
    .wheel-overlay {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0, 0, 0, 0.9);
      z-index: 900;
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    .wheel-header {
      font-size: 3rem; color: #fff; margin-bottom: 20px;
      text-transform: uppercase;
      text-shadow: 0 0 20px #ff00de, 0 0 40px #ff00de;
      animation: flicker 2s infinite;
    }

    /* Khung ch·ª©a v√≤ng quay */
    .wheel-container {
      position: relative;
      width: 400px; height: 400px;
      margin-bottom: 20px;
    }

    /* Kim ch·ªâ (Pointer) */
    .wheel-pointer {
      position: absolute;
      top: -25px; left: 50%;
      transform: translateX(-50%);
      width: 50px; height: 60px;
      background: #8e44ad;
      border: 4px solid #fff;
      border-radius: 50% 50% 5px 5px;
      z-index: 10;
      clip-path: polygon(0% 0%, 100% 0%, 100% 60%, 50% 100%, 0% 60%);
      box-shadow: 0 5px 15px rgba(0,0,0,0.5);
    }
    .wheel-pointer::after {
      content: ''; position: absolute; top: 10px; left: 50%; transform: translateX(-50%);
      width: 15px; height: 15px; background: #f1c40f; border-radius: 50%;
    }

    /* V√≤ng quay ch√≠nh */
    .wheel {
      width: 100%; height: 100%;
      border-radius: 50%;
      border: 10px solid #f1c40f;
      background: #fff;
      position: relative;
      overflow: hidden;
      transition: transform 4s cubic-bezier(0.25, 0.1, 0.25, 1); /* Hi·ªáu ·ª©ng quay ch·∫≠m d·∫ßn */
      box-shadow: 0 0 50px rgba(241, 196, 15, 0.5);
    }

    /* C√°c m√∫i (Segments) - D√πng Conic Gradient ƒë·ªÉ t·∫°o m√†u n·ªÅn */
    .wheel-bg {
      width: 100%; height: 100%;
      background: conic-gradient(
        #e74c3c 0deg 60deg,    /* ƒê·ªè */
        #2ecc71 60deg 120deg,  /* Xanh l√° */
        #3498db 120deg 180deg, /* Xanh d∆∞∆°ng */
        #9b59b6 180deg 240deg, /* T√≠m */
        #f39c12 240deg 300deg, /* Cam */
        #1abc9c 300deg 360deg  /* Xanh ng·ªçc */
      );
      border-radius: 50%;
    }

    /* Nh√£n tr√™n v√≤ng quay */
    .wheel-labels {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    }
    .segment-label {
      position: absolute; top: 50%; left: 50%;
      transform-origin: 0 0;
      width: 50%; /* B√°n k√≠nh */
      text-align: right;
      padding-right: 20px;
      box-sizing: border-box;
      font-weight: bold; font-size: 1.1rem; color: #fff;
      text-shadow: 1px 1px 2px #000;
      display: flex; align-items: center; justify-content: flex-end;
    }
    
    /* N√∫t Quay */
    .spin-btn {
      padding: 15px 50px;
      font-size: 1.5rem;
      background: #e67e22;
      color: white;
      border: 4px solid #fff;
      border-radius: 50px;
      cursor: pointer;
      font-family: 'Orbitron';
      font-weight: 900;
      box-shadow: 0 10px 0 #d35400;
      transition: 0.1s;
    }
    .spin-btn:active { transform: translateY(5px); box-shadow: 0 5px 0 #d35400; }
    .spin-btn:disabled { background: #95a5a6; box-shadow: none; cursor: not-allowed; }

    /* --- HI·ªÜU ·ª®NG QU√Ä T·∫∂NG (Icon m∆∞a r∆°i) --- */
    .reward-container { position: absolute; top: 0; left: 0; right: 0; bottom: 0; pointer-events: none; z-index: 500; overflow: hidden; }
    .reward-item { position: absolute; bottom: -50px; font-size: 3rem; animation: floatUp 3s ease-out forwards; }
    @keyframes floatUp { 0% { transform: translateY(0) rotate(0deg) scale(0.5); opacity: 0; } 10% { opacity: 1; } 100% { transform: translateY(-100vh) rotate(360deg) scale(1.2); opacity: 0; } }

    .reward-message-box { position: absolute; top: 30%; left: 50%; transform: translate(-50%, -50%) scale(0); background: linear-gradient(135deg, #00ff41 0%, #008f24 100%); padding: 1rem 3rem; border: 3px solid #fff; border-radius: 50px; text-align: center; z-index: 950; box-shadow: 0 0 30px rgba(0, 255, 65, 0.8); display: none; }
    .reward-message-box.active { animation: popInMsg 3s forwards; display: block; }
    @keyframes popInMsg { 0% { transform: translate(-50%, -50%) scale(0); opacity: 0; } 10% { transform: translate(-50%, -50%) scale(1.1); opacity: 1; } 20% { transform: translate(-50%, -50%) scale(1); opacity: 1; } 80% { transform: translate(-50%, -50%) scale(1); opacity: 1; } 100% { transform: translate(-50%, -50%) scale(0); opacity: 0; } }
    .reward-title { font-size: 1.5rem; color: #fff; font-weight: bold; margin-bottom: 5px; }
    .reward-name { font-size: 2.5rem; color: #ffff00; font-weight: 900; text-transform: uppercase; text-shadow: 2px 2px 0 #000; }

  </style>
</head>
<body>
  <div class="game-wrapper">
    
    <!-- Start Screen -->
    <div class="start-screen" id="startScreen">
      <div class="neon-title">üèçÔ∏è ƒê∆Ø·ªúNG ƒêUA CH√ÇN L√ù</div>
      <div class="story-intro">
        <p><strong>Lu·∫≠t ch∆°i:</strong> Tr·∫£ l·ªùi ƒë√∫ng s·∫Ω ƒë∆∞·ª£c quay <strong>V√íNG QUAY MAY M·∫ÆN</strong> (C∆° h·ªôi tr√∫ng 1 T·ªâ, SH, Rau m√°...).</p>
        <p>Tr·∫£ l·ªùi sai ƒë√¢m <strong>ƒê√° n·ªï xe</strong>!</p>
      </div>
      <input type="text" class="start-input" id="playerNameInput" placeholder="NH·∫¨P T√äN C·ª¶A B·∫†N..." maxlength="30">
      <button class="start-button" id="startButton">üöÄ KH·ªûI ƒê·ªòNG XE</button>
    </div>

    <!-- Racing Screen -->
    <div class="racing-screen" id="racingScreen">
      <!-- Road & Elements -->
      <div class="highway-container">
        <div class="road" id="road">
          <div class="lane-lines"><div class="lane-line"></div><div class="lane-line"></div><div class="lane-line"></div></div>
        </div>
        <div id="reward-container" class="reward-container"></div>
        <div id="obstacles-container">
          <div class="obstacle" id="rock-A"><div class="rock-graphic"></div></div>
          <div class="obstacle" id="rock-B"><div class="rock-graphic"></div></div>
          <div class="obstacle" id="rock-C"><div class="rock-graphic"></div></div>
          <div class="obstacle" id="rock-D"><div class="rock-graphic"></div></div>
        </div>
        <div id="explosion" class="explosion-container"><div class="explosion-core"></div><div class="explosion-text">B√ôM!</div></div>
        <div class="bike" id="bike">üèçÔ∏è</div>
      </div>

      <div class="hud">
        <div class="hud-item" id="levelDisplay">LEVEL 1/7</div>
        <div class="hud-item hud-score" id="scoreDisplay">ƒêI·ªÇM: 0</div>
      </div>

      <div class="question-panel" id="questionPanel">
        <div class="bullet-time-text">‚è±Ô∏è BULLET TIME ACTIVATED ‚è±Ô∏è</div>
        <div class="question-text" id="questionText">...</div>
        <div class="countdown" id="countdown">10</div>
      </div>

      <div class="lane-choices" id="laneChoices" style="display: none;">
        <div class="lane-choice" data-lane="A"><div class="lane-label">A</div><div class="lane-answer" id="answerA"></div></div>
        <div class="lane-choice" data-lane="B"><div class="lane-label">B</div><div class="lane-answer" id="answerB"></div></div>
        <div class="lane-choice" data-lane="C"><div class="lane-label">C</div><div class="lane-answer" id="answerC"></div></div>
        <div class="lane-choice" data-lane="D"><div class="lane-label">D</div><div class="lane-answer" id="answerD"></div></div>
      </div>
      
      <!-- Th√¥ng b√°o tr√∫ng th∆∞·ªüng -->
      <div id="reward-message-box" class="reward-message-box">
        <div class="reward-title">CH√öC M·ª™NG B·∫†N NH·∫¨N ƒê∆Ø·ª¢C:</div>
        <div class="reward-name" id="reward-name">QU√Ä</div>
      </div>

      <div class="explanation-panel" id="explanationPanel">
        <div class="explanation-title" id="explanationTitle"></div>
        <div class="explanation-text" id="explanationText"></div>
        <button class="next-button" id="nextButton">TI·∫æP T·ª§C ‚ûú</button>
      </div>
    </div>

    <!-- LUCKY WHEEL OVERLAY (M·ªöI) -->
    <div class="wheel-overlay" id="wheelOverlay">
      <div class="wheel-header">üé∞ LUCKY SPIN üé∞</div>
      <div class="wheel-container">
        <div class="wheel-pointer"></div>
        <div class="wheel" id="luckyWheel">
          <div class="wheel-bg"></div>
          <div class="wheel-labels" id="wheelLabels">
            <!-- Labels generated by JS -->
          </div>
        </div>
      </div>
      <button class="spin-btn" id="spinBtn">QUAY NGAY!</button>
    </div>

    <!-- Flashback & Results -->
    <div class="flashback-overlay" id="flashbackOverlay">
      <div class="flashback-title">‚ö†Ô∏è XE N·ªî! FLASHBACK ‚ö†Ô∏è</div>
      <div class="flashback-scene">üî•üê∑üî•</div>
      <div class="flashback-text">Tai n·∫°n th·∫£m kh·ªëc ƒë√£ x·∫£y ra!<br>Gia ƒë√¨nh ph·∫£i b√°n l·ª£n n·ªôp ph·∫°t.</div>
    </div>
    <div class="results-screen" id="resultsScreen">
      <div class="results-trophy">üèÜ</div>
      <div class="results-title">HO√ÄN TH√ÄNH!</div>
      <div class="results-score" id="finalScore"></div>
      <div class="results-message" id="resultsMessage"></div>
      <button class="restart-button" onclick="location.reload()">üîÑ CH∆†I L·∫†I</button>
    </div>

  </div>

  <script>
    /* D·ªÆ LI·ªÜU C√ÇU H·ªéI */
    const questions = [
      { level: 1, question: "Huy·ªÅn Th∆∞ l√† ng∆∞·ªùi vi ph·∫°m, nh∆∞ng y·∫øu t·ªë n√†o l√† 'nguy√™n nh√¢n g·ªëc' t·∫°o ƒëi·ªÅu ki·ªán cho sai ph·∫°m n√†y?", options: { A: "Th∆∞ thi·∫øu hi·ªÉu bi·∫øt lu·∫≠t", B: "B·∫°n b√® r·ªß r√™", C: "Gia ƒë√¨nh cho ph√©p ƒëi xe khi ch∆∞a ƒë·ªß tu·ªïi", D: "Qu·∫£n l√Ω l·ªèng l·∫ªo" }, correct: "C", explanation: "üéØ G·ªêC R·ªÑ N·∫∞M ·ªû S·ª∞ NU√îNG CHI·ªÄU SAI L·∫¶M C·ª¶A PH·ª§ HUYNH!" },
      { level: 2, question: "H√†nh ƒë·ªông n√†o l√† b∆∞·ªõc ngo·∫∑t khi·∫øn s·ª± vi·ªác t·ª´ sai ph·∫°m c√° nh√¢n chuy·ªÉn th√†nh h·∫≠u qu·∫£ x√£ h·ªôi?", options: { A: "L·∫•y xe ƒëi", B: "Nh·∫≠u nh·∫πt", C: "B·ªè ch·∫°y sau khi g√¢y tai n·∫°n", D: "Ch·ªü qu√° s·ªë ng∆∞·ªùi" }, correct: "C", explanation: "üí• B·ªé CH·∫†Y BI·∫æN TAI N·∫†N TH√ÄNH T·ªòI √ÅC!" },
      { level: 3, question: "Th√¥ng ƒëi·ªáp xuy√™n su·ªët k·ªãch b·∫£n v·ªÅ ATGT h·ªçc ƒë∆∞·ªùng l√† g√¨?", options: { A: "H·ªçc sinh thi·∫øu ki·∫øn th·ª©c", B: "C·∫ßn tƒÉng c∆∞·ªùng x·ª≠ ph·∫°t", C: "√ù th·ª©c ch·ªãu chi ph·ªëi t·ª´ Gia ƒë√¨nh - Nh√† tr∆∞·ªùng - X√£ h·ªôi", D: "Tai n·∫°n kh√≥ tr√°nh" }, correct: "C", explanation: "üéì TAM GI√ÅC TR√ÅCH NHI·ªÜM!" },
      { level: 4, question: "√ù nghƒ©a quan tr·ªçng nh·∫•t c·ªßa vi·ªác x·ª≠ ph·∫°t nghi√™m minh h·ªçc sinh l√† g√¨?", options: { A: "L√†m h·ªçc sinh s·ª£", B: "H√¨nh th√†nh √Ω th·ª©c t·ª± gi√°c l√¢u d√†i", C: "Gi·∫£m vi·ªác cho tr∆∞·ªùng", D: "Th·ªÉ hi·ªán quy·ªÅn l·ª±c" }, correct: "B", explanation: "üìö X·ª¨ PH·∫†T ƒê·ªÇ GI√ÅO D·ª§C!" },
      { level: 5, question: "Nh√† tr∆∞·ªùng tuy√™n truy·ªÅn t·ªët, nh∆∞ng gia ƒë√¨nh v·∫´n giao xe cho con ch∆∞a ƒë·ªß tu·ªïi th√¨ sao?", options: { A: "√ù th·ª©c t·ªët l√™n", B: "Ch·ªâ ch·∫•p h√†nh ·ªü tr∆∞·ªùng, d·ªÖ t√°i ph·∫°m ngo√†i x√£ h·ªôi", C: "Tai n·∫°n gi·∫£m", D: "H·ªçc sinh t·ª± ngoan" }, correct: "B", explanation: "üîÑ R·ªêI LO·∫†N GI√Å TR·ªä!" },
      { level: 6, question: "Thay ƒë·ªïi y·∫øu t·ªë then ch·ªët n√†o ƒë·ªÉ ngƒÉn ch·∫∑n to√†n b·ªô chu·ªói h·∫≠u qu·∫£ trong k·ªãch b·∫£n?", options: { A: "Th∆∞ kh√¥ng u·ªëng r∆∞·ª£u", B: "B·∫°n kh√¥ng r·ªß", C: "Gia ƒë√¨nh KH√îNG cho ph√©p d√πng xe m√°y", D: "CSGT l√†m g·∫Øt" }, correct: "C", explanation: "üõ°Ô∏è CH·∫∂N T·ª™ G·ªêC!" },
      { level: 7, question: "C√°ch gi·∫£i quy·∫øt nh√¢n vƒÉn nh·∫•t cho Huy·ªÅn Th∆∞ l√† g√¨?", options: { A: "B·ªè qua", B: "Ph·∫°t nghi√™m nh∆∞ng t·∫°o c∆° h·ªôi s·ª≠a sai", C: "Ph·∫°t n·∫∑ng nh·∫•t", D: "X·ª≠ nh·∫π" }, correct: "B", explanation: "‚öñÔ∏è NGHI√äM MINH NH∆ØNG NH√ÇN VƒÇN!" }
    ];

    /* CONFIG CHO V√íNG QUAY "B·ªäP" */
    // 6 Ph·∫ßn qu√†. G√≥c quay theo chi·ªÅu kim ƒë·ªìng h·ªì.
    // Index 0: 0-60 ƒë·ªô, Index 1: 60-120 ƒë·ªô...
    const wheelItems = [
      { text: "1 T·ªà üíé", type: "fake" },      // 0
      { text: "RAU M√Å üåø", type: "real" },    // 1 (Target)
      { text: "SH 150i üèçÔ∏è", type: "fake" },   // 2
      { text: "NEM CHUA üåØ", type: "real" },  // 3 (Target)
      { text: "BI·ªÜT TH·ª∞ üè†", type: "fake" },  // 4
      { text: "RAU M√Å üåø", type: "real" }     // 5 (Target)
    ];

    /* LOGIC GAME */
    let currentLevel = 0;
    let score = 0;
    let phase = "start"; 
    let countdownTimer = null;
    let wheelRotation = 0;

    // Setup Wheel UI
    function initWheel() {
      const labelsContainer = document.getElementById('wheelLabels');
      labelsContainer.innerHTML = '';
      const segAngle = 360 / wheelItems.length;

      wheelItems.forEach((item, index) => {
        const label = document.createElement('div');
        label.className = 'segment-label';
        label.textContent = item.text;
        // Xoay label ƒë·ªÉ n√≥ h∆∞·ªõng ra ngo√†i. +30 l√† ƒë·ªÉ cƒÉn gi·ªØa m√∫i 60 ƒë·ªô (0-60 th√¨ gi·ªØa l√† 30)
        label.style.transform = `rotate(${index * segAngle + (segAngle/2)}deg) translate(0px, -50%)`; 
        labelsContainer.appendChild(label);
      });
    }
    initWheel();

    document.getElementById('startButton').addEventListener('click', () => {
      const name = document.getElementById('playerNameInput').value.trim();
      if (!name) { alert("Vui l√≤ng nh·∫≠p t√™n!"); return; }
      document.getElementById('startScreen').style.display = 'none';
      document.getElementById('racingScreen').style.display = 'block';
      currentLevel = 0; score = 0; startLevel();
    });

    function startLevel() {
      if (currentLevel >= questions.length) { showResults(); return; }
      const q = questions[currentLevel];
      
      document.getElementById('levelDisplay').textContent = `LEVEL ${q.level}/7`;
      document.getElementById('scoreDisplay').textContent = `ƒêI·ªÇM: ${score}`;
      document.getElementById('reward-message-box').classList.remove('active');
      document.getElementById('reward-container').innerHTML = ''; // Clear rain

      // Reset scene
      const bike = document.getElementById('bike');
      bike.className = 'bike'; 
      document.querySelectorAll('.obstacle').forEach(o => o.style.display = 'none');
      document.getElementById('explosion').className = 'explosion-container';
      
      document.getElementById('road').classList.add('slow-motion');
      document.querySelectorAll('.lane-line').forEach(l => l.classList.add('slow-motion'));

      document.getElementById('questionPanel').style.display = 'block';
      document.getElementById('laneChoices').style.display = 'none';
      document.getElementById('explanationPanel').style.display = 'none';
      
      document.getElementById('questionText').textContent = q.question;
      document.getElementById('answerA').textContent = q.options.A;
      document.getElementById('answerB').textContent = q.options.B;
      document.getElementById('answerC').textContent = q.options.C;
      document.getElementById('answerD').textContent = q.options.D;

      startCountdown(10, () => {
        document.getElementById('questionPanel').style.display = 'none';
        document.getElementById('laneChoices').style.display = 'flex';
        document.getElementById('road').classList.remove('slow-motion');
        document.querySelectorAll('.lane-line').forEach(l => l.classList.remove('slow-motion'));
        document.querySelectorAll('.lane-choice').forEach(l => {
          l.classList.remove('correct', 'incorrect');
          l.style.pointerEvents = 'auto';
        });
        phase = "choosing";
      });
    }

    function startCountdown(seconds, onComplete) {
      let timeLeft = seconds;
      const el = document.getElementById('countdown');
      el.textContent = timeLeft;
      if(countdownTimer) clearInterval(countdownTimer);
      countdownTimer = setInterval(() => {
        timeLeft--;
        el.textContent = timeLeft;
        if (timeLeft <= 0) {
          clearInterval(countdownTimer);
          if (onComplete) onComplete();
        }
      }, 1000); 
    }

    // X·ª≠ l√Ω ch·ªçn ƒë√°p √°n
    document.querySelectorAll('.lane-choice').forEach(laneBtn => {
      laneBtn.addEventListener('click', () => {
        if (phase !== "choosing") return;
        phase = "answered";
        if (countdownTimer) clearInterval(countdownTimer);

        const selected = laneBtn.dataset.lane;
        const q = questions[currentLevel];
        const isCorrect = (selected === q.correct);

        document.querySelectorAll('.lane-choice').forEach(l => l.style.pointerEvents = 'none');

        // Logic ƒê√° & N·ªï (Sai)
        const lanes = ['A', 'B', 'C', 'D'];
        lanes.forEach(lane => {
          if (lane !== q.correct) {
            const rock = document.getElementById(`rock-${lane}`);
            rock.classList.add(`lane-${lane.toLowerCase()}`);
            rock.style.display = 'block';
          }
        });

        const bike = document.getElementById('bike');
        bike.classList.add(`lane-${selected.toLowerCase()}`);

        setTimeout(() => {
          document.querySelectorAll('.lane-choice').forEach(l => {
            if (l.dataset.lane === q.correct) l.classList.add('correct');
            else if (l.dataset.lane === selected && !isCorrect) l.classList.add('incorrect');
          });

          if (isCorrect) {
            score += 100;
            document.getElementById('scoreDisplay').textContent = `ƒêI·ªÇM: ${score}`;
            
            // THAY ƒê·ªîI L·ªöN: Hi·ªán v√≤ng quay thay v√¨ hi·ªán gi·∫£i th√≠ch ngay
            setTimeout(() => {
                openLuckyWheel(q.explanation);
            }, 500);

          } else {
            // SAI -> N·ªï -> Flashback
            bike.classList.add('crashed'); 
            const explosion = document.getElementById('explosion');
            explosion.classList.add(`lane-${selected.toLowerCase()}`); 
            explosion.classList.add('active'); 
            setTimeout(() => {
              showFlashback(() => { showExplanation(false, q.explanation); });
            }, 1200);
          }
        }, 500);
      });
    });

    /* --- LOGIC V√íNG QUAY MAY M·∫ÆN (RIGGED) --- */
    function openLuckyWheel(explanationText) {
        const overlay = document.getElementById('wheelOverlay');
        const spinBtn = document.getElementById('spinBtn');
        overlay.style.display = 'flex';
        spinBtn.disabled = false;
        spinBtn.textContent = "QUAY NGAY!";

        // G√°n s·ª± ki·ªán click cho n√∫t quay (ch·ªâ 1 l·∫ßn per question)
        spinBtn.onclick = () => {
            spinBtn.disabled = true;
            spinBtn.textContent = "ƒêANG QUAY...";
            
            // 1. Ch·ªçn qu√† (B·ªãp: Ch·ªâ ch·ªçn Rau M√° ho·∫∑c Nem Chua)
            // L·ªçc ra c√°c index c√≥ type l√† 'real'
            const realIndices = [1, 3, 5]; 
            // Ch·ªçn ng·∫´u nhi√™n 1 trong c√°c index "real"
            const targetIndex = realIndices[Math.floor(Math.random() * realIndices.length)];
            const winningItem = wheelItems[targetIndex];

            // 2. T√≠nh to√°n g√≥c quay
            // M·ªôt m√∫i l√† 60 ƒë·ªô. M√∫i 0 l√† 0-60, M√∫i 1 l√† 60-120...
            // ƒê·ªÉ kim ch·ªâ v√†o gi·ªØa m√∫i i, ta c·∫ßn g√≥c quay l√†: -(i * 60 + 30)
            // L∆∞u √Ω: V√≤ng quay quay CSS rotate d∆∞∆°ng (chi·ªÅu kim ƒë·ªìng h·ªì), kim ·ªü tr√™n c√πng (0 ƒë·ªô).
            // N·∫øu mu·ªën kim ch·ªâ v√†o 60 ƒë·ªô, v√≤ng quay ph·∫£i xoay -60 ƒë·ªô (ho·∫∑c 300 ƒë·ªô).
            
            // ƒê·ªÉ ƒë∆°n gi·∫£n: Kim ·ªü g√≥c 0. M√∫i 1 ·ªü 60-120. ƒê·ªÉ M√∫i 1 n·∫±m d∆∞·ªõi kim, ta xoay v√≤ng quay sao cho 90 ƒë·ªô (gi·ªØa m√∫i 1) v·ªÅ 0.
            // => Xoay -90 ƒë·ªô. 
            // C√¥ng th·ª©c t·ªïng qu√°t: Target Angle = - (index * 60 + 30);
            
            const segmentAngle = 360 / wheelItems.length; // 60
            const stopAngle = -(targetIndex * segmentAngle + segmentAngle/2); 

            // Th√™m nhi·ªÅu v√≤ng quay (5 v√≤ng = 1800 ƒë·ªô) + th√™m ch√∫t random jitter (-10 ƒë·∫øn +10 ƒë·ªô) cho t·ª± nhi√™n
            const extraSpins = 360 * 8; 
            const jitter = Math.floor(Math.random() * 20) - 10;
            
            // T√≠nh to√°n rotation m·ªõi. C·∫ßn c·ªông d·ªìn rotation c≈© ƒë·ªÉ quay ti·∫øp ch·ª© kh√¥ng quay ng∆∞·ª£c l·∫°i.
            // ƒê·ªÉ ƒë·∫£m b·∫£o quay ƒë√∫ng, ta l·∫•y rotation hi·ªán t·∫°i l√†m m·ªëc.
            // C√°ch hack: Reset transition, set rotation v·ªÅ 0 (·∫£o gi√°c) ho·∫∑c c·ª© c·ªông d·ªìn. C·ªông d·ªìn l√† t·ªët nh·∫•t.
            
            // T√≠nh v·ªã tr√≠ ƒë√≠ch th·ª±c t·∫ø c·∫ßn ƒë·∫°t t·ªõi
            let currentMod = wheelRotation % 360;
            let distToTarget = stopAngle - currentMod;
            // ƒê·∫£m b·∫£o quay theo chi·ªÅu kim ƒë·ªìng h·ªì (d∆∞∆°ng)
            while (distToTarget < 0) { distToTarget += 360; }
            
            // T·ªïng g√≥c quay
            const totalRotation = wheelRotation + extraSpins + distToTarget + jitter;
            
            // Th·ª±c hi·ªán quay
            const wheel = document.getElementById('luckyWheel');
            wheel.style.transform = `rotate(${totalRotation}deg)`;
            
            wheelRotation = totalRotation; // L∆∞u l·∫°i cho l·∫ßn sau

            // 3. X·ª≠ l√Ω sau khi quay xong (4 gi√¢y)
            setTimeout(() => {
                // ƒê√≥ng v√≤ng quay
                overlay.style.display = 'none';
                
                // K√≠ch ho·∫°t hi·ªáu ·ª©ng m∆∞a qu√† t·∫∑ng
                triggerReward(winningItem.text);

                // Sau ƒë√≥ hi·ªán gi·∫£i th√≠ch b√†i h·ªçc
                setTimeout(() => {
                    showExplanation(true, explanationText);
                }, 2000); // ƒê·ª£i ng·∫Øm m∆∞a 2s r·ªìi hi·ªán b·∫£ng
                
            }, 4000); // Kh·ªõp v·ªõi transition css 4s
        };
    }

    // H√ÄM T·∫∂NG QU√Ä & M∆ØA ICON
    function triggerReward(itemName) {
      // X√°c ƒë·ªãnh icon d·ª±a tr√™n t√™n
      let icon = "üéÅ";
      if (itemName.includes("RAU M√Å")) icon = "üåø";
      if (itemName.includes("NEM CHUA")) icon = "üåØ";

      const msgBox = document.getElementById('reward-message-box');
      document.getElementById('reward-name').textContent = itemName;
      
      // M√†u ch·ªØ
      if(icon === "üåø") document.getElementById('reward-name').style.color = "#00ff41";
      else document.getElementById('reward-name').style.color = "#ff006e";

      msgBox.classList.add('active');

      // M∆∞a icon
      const container = document.getElementById('reward-container');
      container.innerHTML = ''; 
      for (let i = 0; i < 25; i++) {
        const item = document.createElement('div');
        item.classList.add('reward-item');
        item.textContent = icon;
        item.style.left = Math.random() * 100 + "%";
        item.style.animationDuration = (2 + Math.random() * 2) + "s";
        item.style.fontSize = (2 + Math.random() * 2) + "rem"; 
        container.appendChild(item);
      }
    }

    function showFlashback(callback) {
      const fb = document.getElementById('flashbackOverlay');
      fb.style.display = 'flex';
      setTimeout(() => { fb.style.display = 'none'; if (callback) callback(); }, 3500); 
    }

    function showExplanation(isCorrect, text) {
      document.getElementById('laneChoices').style.display = 'none';
      const panel = document.getElementById('explanationPanel');
      const title = document.getElementById('explanationTitle');
      panel.style.display = 'block';
      title.textContent = isCorrect ? "‚úÖ CH√çNH X√ÅC! AN TO√ÄN TUY·ªÜT ƒê·ªêI" : "‚ùå TAI N·∫†N KINH HO√ÄNG!";
      title.className = isCorrect ? "explanation-title correct" : "explanation-title incorrect";
      document.getElementById('explanationText').textContent = text;
    }

    document.getElementById('nextButton').addEventListener('click', () => { currentLevel++; startLevel(); });
    function showResults() {
      document.getElementById('racingScreen').style.display = 'none';
      document.getElementById('resultsScreen').style.display = 'flex';
      let msg = "";
      if (score >= 700) msg = "TUY·ªÜT V·ªúI! B·∫°n l√† m·ªôt B·ªô tr∆∞·ªüng Giao th√¥ng t∆∞∆°ng lai!";
      else msg = "C·∫¶N C·ªê G·∫ÆNG! H√£y nh·ªõ r·∫±ng sai l·∫ßm tr√™n ƒë∆∞·ªùng kh√¥ng th·ªÉ l√†m l·∫°i.";
      document.getElementById('finalScore').textContent = `${score}/700 ƒêI·ªÇM`;
      document.getElementById('resultsMessage').textContent = msg;
    }
  </script>
</body>
</html>
